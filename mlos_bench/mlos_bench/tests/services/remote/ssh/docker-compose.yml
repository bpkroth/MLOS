services:
  ssh-server:
    attach: false
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - PORT=${PORT:-2254}
      tags:
        - mlos_bench-test-ssh-server:latest
    ports:
      - ${PORT:-2254}:${PORT:-2254}
    extra_hosts:
      - host.docker.internal:host-gateway
    environment:
      # Let the environment variable TIMEOUT override the default.
      - TIMEOUT=${TIMEOUT:-180}
  # Check that we can connect to the server from the client.
  ssh-client:
    depends_on:
      - ssh-server
    restart: no
    image: mlos_bench-test-ssh-server:latest
    extra_hosts:
      - host.docker.internal:host-gateway
    # Implicitly uses root and the key in that image.
    command: ["ssh", "-o", "StrictHostKeyChecking=accept-new", "-p", "${PORT:-2254}", "host.docker.internal", "hostname"]
